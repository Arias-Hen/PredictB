<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PredictBuild Dashboard</title>
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" as="style"
        onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    </noscript>
    {% extends 'sidebar.html' %}
    {% load static %}
    {% block content %}
</head>

<body>

    <div class="container-fluid p-0 m-0">
        <!-- Título (azul completo) -->
        <div class="top-bar d-flex flex-column px-0">
            <div class="row g-0 text-black filters-row align-items-center"
                style="height: 70px; background-color: white;">
                <div class="col-md-1 text-start ps-3"></div>
                <div class="col-md-3">
                    <h4 class="m-0" style="color: #001ba3;">INFORMES</h4>
                </div>
                <div class="col-md-4 text-center">
                    <img src="{% static 'images/logo.jpeg' %}" alt="Logo"
                        style="width: 100px; height: 80px; object-fit: contain;">
                </div>
            </div>
            <!-- Barra de búsqueda -->
            <div class="row g-0">
                <div class="col-12 bg-blue p-2">
                    <div class="row ms-1">
                        <div class="col-md-4">
                            <input type="text" class="form-control" placeholder="BUSQUE POR DIRECCIÓN">
                        </div>
                    </div>
                </div>
            </div>
            <!-- Filtros -->
            <div class="row g-0 filter-section">
                <div class="col-12 bg-blue p-2">
                    <form class="row gx-2 gy-1 align-items-end">
                        <div class="col-6 col-md-2 col-lg-1">
                            <label class="form-label mb-1">Desde:</label>
                            <input type="date" class="form-control form-control-sm" id="desde">
                        </div>
                        <div class="col-6 col-md-2 col-lg-1">
                            <label class="form-label mb-1">Hasta:</label>
                            <input type="date" class="form-control form-control-sm" id="hasta">
                        </div>
                        <div class="col-6 col-md-2 col-lg-1">
                            <label class="form-label mb-1">Ciudad:</label>
                            <select id="ciudad_1" class="form-select form-select-sm" aria-label="Seleccionar ciudad"
                                onchange="cargarDistritos('1')"></select>
                        </div>
                        <div class="col-6 col-md-2 col-lg-1">
                            <label class="form-label mb-1">Distrito:</label>
                            <select id="distrito_1" class="form-select form-select-sm"
                                onchange="cargarBarrios('1')"></select>
                        </div>
                        <div class="col-6 col-md-2 col-lg-1">
                            <label class="form-label mb-1">Barrio:</label>
                            <select id="barrio_1" class="form-select form-select-sm"
                                onchange="cargarCalle('1')"></select>
                        </div>
                        <div class="col-6 col-md-2 col-lg-1">
                            <label class="form-label mb-1">Calle:</label>
                            <select id="calle_1" class="form-select form-select-sm"></select>
                        </div>
                        <div class="col-6 col-md-2 col-lg-1">
                            <label class="form-label mb-1">Tipo:</label>
                            <select id="tipo_1" class="form-select form-select-sm">
                                <option value="">Todos</option>
                                <option value="valoracion">valoracion</option>
                                <option value="registro">registro</option>
                                <option value="informe">informe</option>
                            </select>
                        </div>
                        <div class="col-6 col-md-3 col-lg-2">
                            <label class="form-label mb-1">Precio Desde:</label>
                            <select class="form-select form-select-sm">
                                <option>200.000</option>
                            </select>
                        </div>
                        <div class="col-6 col-md-3 col-lg-2">
                            <label class="form-label mb-1">Precio Hasta:</label>
                            <select class="form-select form-select-sm">
                                <option>3.000.000</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-2 col-lg-1">
                            <button type="button" class="btn btn-clear btn-sm w-100 mt-2">LIMPIAR FILTROS</button>
                        </div>
                    </form>
                </div>
            </div>
            <!-- Tabla -->
            <div class="row g-0">
                <div class="col-lg-12 p-0 m-0">
                    <div class="table-section p-0 m-0">
                        <table id="valoraciones-table" class="table table-sm table-bordered w-100 m-0">
                            <thead>
                                <tr>
                                    <th>Seleccionar</th>
                                    <th>Fecha</th>
                                    <th>Estado</th>
                                    <th>Precio</th>
                                    <th>Ubicación</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for valoracion in valoraciones %}
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>{{ valoracion.fecha_guardado }}</td>
                                    <td>{{ valoracion.modo }}</td>
                                    <td>
                                        {% if valoracion.precio_esperado_unico %}
                                        {% if valoracion.precio_esperado_unico != 0 %}
                                        {{ valoracion.precio_esperado_unico }}
                                        {% else %}
                                        {{ valoracion.precio_esperado }}
                                        {% endif %}
                                        {% else %}
                                        {{ valoracion.precio_esperado }}
                                        {% endif %}
                                    </td>
                                    <td>{{ valoracion.calle }},
                                        {{ valoracion.barrio }},
                                        {{ valoracion.distrito }},
                                        {{ valoracion.ciudad }}</td>
                                    <!-- columnas ocultas -->
                                    <td class="hidden-column">{{ valoracion.planta }}</td>
                                    <td class="hidden-column">{{ valoracion.distrito }}</td>
                                    <td class="hidden-column">{{ valoracion.barrio }}</td>
                                    <td class="hidden-column">{{ valoracion.calle }}</td>
                                    <td class="hidden-column">{{ valoracion.tipo_vivienda }}</td>
                                    <td class="hidden-column">{{ valoracion.estado }}</td>
                                    <td class="hidden-column">{{ valoracion.m2 }}</td>
                                    <td class="hidden-column">{{ valoracion.num_habitaciones }}</td>
                                    <td class="hidden-column">{{ valoracion.num_banos }}</td>
                                    <td class="hidden-column">{{ valoracion.terraza }}</td>
                                    <td class="hidden-column">{{ valoracion.balcon }}</td>
                                    <td class="hidden-column">{{ valoracion.ascensor }}</td>
                                    <td class="hidden-column">{{ valoracion.precio_minimo }}</td>
                                    <td class="hidden-column">{{ valoracion.precio_esperado }}</td>
                                    <td class="hidden-column">{{ valoracion.precio_maximo }}</td>
                                    <td class="hidden-column">{{ valoracion.precio_esperado_unico }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="table-container text-center mt-3">
                        <button class="export-to-excel btn btn-danger mb-2 btn-spacing" onclick="exportToPDF()">
                            EXPORTAR A PDF
                        </button>
                        <button class="open-record btn btn-primary mb-2 btn-spacing"
                            style="background-color: #001ba3 !important; color: #fff !important;">
                            Enviar a
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-envelope" viewBox="0 0 16 16">
                                <path
                                    d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1zm13 2.383-4.708 2.825L15 11.105zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741M1 11.105l4.708-2.897L1 5.383z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
<script>
    document.getElementById('tipo_1').addEventListener('change', filtrarTodo);

    document.getElementById('desde').addEventListener('change', filtrarTodo);
    document.getElementById('hasta').addEventListener('change', filtrarTodo);
    window.addEventListener('DOMContentLoaded', () => {
        const hoy = new Date();
        const yyyy = hoy.getFullYear();
        const mm = String(hoy.getMonth() + 1).padStart(2, '0');
        const dd = String(hoy.getDate()).padStart(2, '0');

        const fechaHoy = `${yyyy}-${mm}-${dd}`;
        const fechaEnero = `${yyyy}-01-01`;

        const desdeInput = document.getElementById('desde');
        const hastaInput = document.getElementById('hasta');

        if (desdeInput && !desdeInput.value) desdeInput.value = fechaEnero;
        if (hastaInput && !hastaInput.value) hastaInput.value = fechaHoy;
    });

    const optionsJson = '{{ options_json|escapejs }}';
    const ciudadSe = JSON.parse('{{ context_json|escapejs }}');

    if (optionsJson.trim() === "") {
        console.error("La variable options_json está vacía.");
    } else {
        const selectCiudad = document.getElementById('ciudad');
        cargarCiudades('1')
        cargarCiudades('2')
    }
    function cargarCiudades(sufijo) {
        if (optionsJson.trim() === "") {
            console.error("La variable options_json está vacía.");
            return;
        }

        const options = JSON.parse(optionsJson);

        const selectCiudad = document.getElementById('ciudad_' + sufijo);

        selectCiudad.innerHTML = '';
        if (sufijo == 1) {
            const optionTodos = document.createElement('option');
            optionTodos.value = '';
            optionTodos.textContent = 'Todos';
            optionTodos.selected = true;
            selectCiudad.appendChild(optionTodos);
        }
        options.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option.id;
            optionElement.textContent = option.name;
            selectCiudad.appendChild(optionElement);
        });
        if (sufijo != 1) {
            const ciudad = ciudadSe.ciudad;
            if (ciudad) {
                const optionToSelect = Array.from(selectCiudad.options).find(option => option.value === ciudad);
                if (optionToSelect) {
                    optionToSelect.selected = true;
                    selectCiudad.dispatchEvent(new Event('change'));
                }
            }
        }
        if (sufijo == 1) {
            filtrarTodo();
        }
    }

    function cargarDistritos(sufijo) {
        const ciudadSelect = document.getElementById('ciudad_' + sufijo);
        const distritoSelect = document.getElementById('distrito_' + sufijo);

        const ciudadSeleccionada = ciudadSelect?.value;
        if (!ciudadSeleccionada) {
            if (distritoSelect) distritoSelect.innerHTML = '';
            console.log("a");
            return;
        }

        console.log(`URL de la solicitud: /home/get_distritos/${encodeURIComponent(ciudadSeleccionada)}/`);

        fetch(`/home/get_distritos/${encodeURIComponent(ciudadSeleccionada)}/`)
            .then(response => response.json())
            .then(data => {
                if (!distritoSelect) return;

                distritoSelect.innerHTML = '';

                if (sufijo == 1) {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = "Todos";
                    defaultOption.selected = true;
                    distritoSelect.appendChild(defaultOption);
                }

                data.distritos.forEach(distrito => {
                    const option = document.createElement('option');
                    option.value = distrito.id;
                    option.textContent = distrito.name;
                    distritoSelect.appendChild(option);
                });

                if (sufijo != 1) {
                    const distritoSe = JSON.parse('{{ context_json|escapejs }}');
                    const distrito = distritoSe.distrito;
                    console.log("distrito:", distrito);
                    if (distrito) {
                        const seleccion = Array.from(distritoSelect.options).find(option => option.value === distrito);
                        if (seleccion) {
                            seleccion.selected = true;
                            distritoSelect.dispatchEvent(new Event('change'));
                        }
                    }
                }
            })
            .catch(error => console.error('Error al cargar los distritos:', error));

        if (sufijo == 1) {
            filtrarTodo();
        }
    }
    function cargarBarrios(sufijo) {
        const distritoSelect = document.getElementById('distrito_' + sufijo);
        const barrioSelect = document.getElementById('barrio_' + sufijo);

        const distritoSeleccionado = distritoSelect?.value;

        if (!distritoSeleccionado) {
            console.log("No se seleccionó ningún distrito.");
            if (barrioSelect) barrioSelect.innerHTML = '';
            return;
        }

        console.log(`URL de la solicitud: /home/get_barrios/${encodeURIComponent(distritoSeleccionado)}/`);

        fetch(`/home/get_barrios/${encodeURIComponent(distritoSeleccionado)}/`)
            .then(response => response.json())
            .then(data => {
                console.log('Datos recibidos del servidor:', data);

                if (!barrioSelect) return;
                barrioSelect.innerHTML = '';
                if (sufijo == 1) {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = "Todos";
                    defaultOption.selected = true;
                    barrioSelect.appendChild(defaultOption);
                }

                data.barrio.forEach(barrio => {
                    const option = document.createElement('option');
                    option.value = barrio.id;
                    option.textContent = barrio.name;
                    barrioSelect.appendChild(option);
                });

                if (sufijo != 1) {
                    const barrioSe = JSON.parse('{{ context_json|escapejs }}');
                    const barrio = barrioSe.barrio;
                    if (barrio) {
                        const seleccion = Array.from(barrioSelect.options).find(option => option.value === barrio);
                        if (seleccion) {
                            seleccion.selected = true;
                            barrioSelect.dispatchEvent(new Event('change'));
                        }
                    }
                }
            })
            .catch(error => console.error('Error al cargar los barrios:', error));

        if (sufijo == 1) {
            filtrarTodo();
        }
    }

    function cargarCalle(sufijo) {
        const barrioSelect = document.getElementById('barrio_' + sufijo);
        const calleSelect = document.getElementById('calle_' + sufijo);

        const barrioSeleccionado = barrioSelect?.value;

        if (!barrioSeleccionado) {
            console.log("No se seleccionó ningún barrio.");
            if (calleSelect) calleSelect.innerHTML = '';
            return;
        }

        console.log(`URL de la solicitud: /home/get_calles/${encodeURIComponent(barrioSeleccionado)}/`);

        fetch(`/home/get_calles/${encodeURIComponent(barrioSeleccionado)}/`)
            .then(response => response.json())
            .then(data => {
                console.log('Datos recibidos del servidor:', data);

                if (!calleSelect) return;
                calleSelect.innerHTML = '';

                if (sufijo == 1) {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = "Todos";
                    defaultOption.selected = true;
                    calleSelect.appendChild(defaultOption);
                }

                data.calle.forEach(calle => {
                    const option = document.createElement('option');
                    option.value = calle.id;
                    option.textContent = calle.name;
                    calleSelect.appendChild(option);
                });

                if (sufijo != 1) {
                    const calleSe = JSON.parse('{{ context_json|escapejs }}');
                    const calle = calleSe.calle;
                    if (calle) {
                        const seleccion = Array.from(calleSelect.options).find(option => option.value === calle);
                        if (seleccion) {
                            seleccion.selected = true;
                            calleSelect.dispatchEvent(new Event('change'));
                        }
                    }
                }
            })
            .catch(error => console.error('Error al cargar las calles:', error));

        if (sufijo == 1) {
            filtrarTodo();
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        const ciudadSe = JSON.parse('{{ context_json|escapejs }}');
        console.log("JEISON", ciudadSe)
        if (ciudadSe) {
            document.getElementById('num-banos').value = ciudadSe.num_banos || '';
            document.getElementById('num-habitaciones').value = ciudadSe.num_habitaciones || '';
            document.getElementById('metros-cuadrados').value = ciudadSe.m2 || '';

            const plantaSelect = document.getElementById('planta');
            plantaSelect.value = ciudadSe.planta || '';

            const ascensorSelect = document.getElementById('tiene-ascensor');
            ascensor = ciudadSe.ascensor;
            if (ascensor !== undefined && ascensor !== null) {
                const seleccion = Array.from(ascensorSelect.options).find(option => option.value === String(ascensor));
                if (seleccion) {
                    seleccion.selected = true;
                    ascensorSelect.dispatchEvent(new Event('change'));
                }
            }
            const estadoSelect = document.getElementById('estado-inmueble');
            estadoSelect.value = ciudadSe.estado || '';

            const tipoSelect = document.getElementById('tipo-vivienda');
            tipoSelect.value = ciudadSe.tipo_vivienda || '';

            const terrazaSelect = document.getElementById('tiene-terraza');
            terrazaSelect.value = ciudadSe.terraza || '';

            const balconSelect = document.getElementById('tiene-balcon');
            balconSelect.value = ciudadSe.balcon || '';


            const precio_min = document.getElementById('precio-minimo');
            precio_min.textContent = ciudadSe.precio_minimo || '';

            const precio_max = document.getElementById('precio-maximo');
            precio_max.textContent = ciudadSe.precio_maximo || '';

            const precio_esp = document.getElementById('precio-esperado');
            precio_esp.textContent = ciudadSe.precio_esperado || '';

            const precio_esu = document.getElementById('precio-esperado-unico');
            precio_esu.textContent = ciudadSe.precio_esperado_unico || '';

        }
    });


    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    function filtrarTodo() {
        console.log("filtrarTodo ejecutado");

        const desdeInput = document.getElementById('desde');
        const hastaInput = document.getElementById('hasta');
        const tipoInput = document.getElementById('tipo_1');
        const precioDesdeInput = document.getElementById('precio-desde');
        const precioHastaInput = document.getElementById('precio-hasta');

        let desdeStr = desdeInput?.value || '';
        let hastaStr = hastaInput?.value || '';
        let tipo = tipoInput?.value.toLowerCase() || '';
        let precioDesde = parseFloat(precioDesdeInput?.value) || 0;
        let precioHasta = parseFloat(precioHastaInput?.value) || Infinity;

        if (tipo === 'todos' || tipo === 'seleccionar') tipo = '';

        let ciudad = document.getElementById('ciudad_1')?.value.toLowerCase() || '';
        let distrito = document.getElementById('distrito_1')?.value.toLowerCase() || '';
        let barrio = document.getElementById('barrio_1')?.value.toLowerCase() || '';
        let calle = document.getElementById('calle_1')?.value.toLowerCase() || '';

        if (distrito === 'todos' || distrito === 'seleccionar') distrito = '';
        if (barrio === 'todos' || barrio === 'seleccionar') barrio = '';
        if (calle === 'todos' || calle === 'seleccionar') calle = '';

        const tabla = document.getElementById('valoraciones-table');
        const filas = tabla.tBodies[0].rows;

        for (let fila of filas) {
            let mostrar = true;

            // Fecha
            const textoFecha = fila.cells[1].textContent.trim();
            const partes = textoFecha.split('/');
            let fechaFilaStr = '';

            if (partes.length === 3) {
                const dia = partes[0].padStart(2, '0');
                const mes = partes[1].padStart(2, '0');
                const anio = partes[2];
                fechaFilaStr = `${anio}-${mes}-${dia}`;
            }

            if (desdeStr && fechaFilaStr < desdeStr) mostrar = false;
            if (hastaStr && fechaFilaStr > hastaStr) mostrar = false;

            if (tipo && !fila.cells[2].textContent.toLowerCase().includes(tipo)) mostrar = false;

            if (ciudad && !fila.cells[4].textContent.toLowerCase().includes(ciudad)) mostrar = false;

            if (distrito && !fila.cells[6].textContent.toLowerCase().includes(distrito)) mostrar = false;
            if (barrio && !fila.cells[7].textContent.toLowerCase().includes(barrio)) mostrar = false;
            if (calle && !fila.cells[8].textContent.toLowerCase().includes(calle)) mostrar = false;

            const textoPrecio = fila.cells[3].textContent.trim().replace(/\./g, '').replace(',', '.');
            const precio = parseFloat(textoPrecio) || 0;
            if (precio < precioDesde || precio > precioHasta) mostrar = false;

            fila.style.display = mostrar ? '' : 'none';
        }
    }


    document.querySelectorAll('.filter-section input, .filter-section select').forEach(elem => {
        elem.addEventListener('change', filtrarTodo);
    });


    document.getElementById('ciudad_1').addEventListener('change', () => {
        document.getElementById('distrito_1').innerHTML = '<option value="">-- Seleccionar distrito --</option>';
        document.getElementById('barrio_1').innerHTML = '<option value="">-- Seleccionar barrio --</option>';
        document.getElementById('calle_1').innerHTML = '<option value="">-- Seleccionar calle --</option>';
        filtrarTodo();
    });
    document.getElementById('distrito_1').addEventListener('change', () => {
        document.getElementById('barrio_1').innerHTML = '<option value="">-- Seleccionar barrio --</option>';
        document.getElementById('calle_1').innerHTML = '<option value="">-- Seleccionar calle --</option>';
        filtrarTodo();
    });
    document.getElementById('barrio_1').addEventListener('change', () => {
        document.getElementById('calle_1').innerHTML = '<option value="">-- Seleccionar calle --</option>';
        filtrarTodo();
    });

    document.querySelectorAll('.filter-section input, .filter-section select').forEach(elem => {
        elem.addEventListener('change', filtrarTodo);
    });
    document.getElementById('desde').addEventListener('change', filtrarTodo);
    document.getElementById('hasta').addEventListener('change', filtrarTodo);


    async function exportToPDF() {
        const selectedRows = [];

        // Obtener filas seleccionadas
        document.querySelectorAll('tbody tr').forEach(row => {
            const checkbox = row.querySelector('input[type="checkbox"]');
            if (checkbox && checkbox.checked) {
                const rowData = {
                    metros_cuadrados: parseFloat(row.querySelector('td:nth-child(12)').textContent.trim()) || 0,
                    num_habitaciones: parseInt(row.querySelector('td:nth-child(13)').textContent.trim()) || 0,
                    num_banos: parseInt(row.querySelector('td:nth-child(14)').textContent.trim()) || 0,
                    ascensor: row.querySelector('td:nth-child(18)').textContent.trim() === 'True' ? '1' : '0'
                };
                selectedRows.push(rowData);
            }
        });

        // Validaciones
        if (selectedRows.length === 0) {
            alert('Por favor, seleccione al menos una fila para generar el PDF.');
            return;
        }
        if (selectedRows.length > 1) {
            alert('Por favor, seleccione solo una fila para generar el PDF.');
            return;
        }

        const selectedData = selectedRows[0];
        console.log("Datos a enviar:", selectedData);

        // Crear input de archivo para imágenes
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.multiple = true;

        fileInput.onchange = async (e) => {
            const files = e.target.files;
            if (!files || files.length === 0) {
                alert('Por favor, seleccione al menos una imagen.');
                return;
            }

            // Mostrar mensaje de carga
            const loadingAlert = alert('Generando PDF, por favor espere...');

            // Abrir ventana inmediatamente (mejor compatibilidad con bloqueadores)
            const pdfWindow = window.open('', '_blank');

            try {
                // Crear FormData con los datos
                const formData = new FormData();
                formData.append('metros_cuadrados', selectedData.metros_cuadrados);
                formData.append('habitaciones', selectedData.num_habitaciones);
                formData.append('banos', selectedData.num_banos);
                formData.append('ascensor', selectedData.ascensor);

                // Añadir imágenes
                Array.from(files).forEach(file => {
                    formData.append('imagenes[]', file);
                });

                // Enviar datos al servidor
                const response = await fetch("/home/api/vivienda/", {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCsrfToken(),
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.status}`);
                }

                const data = await response.json();
                console.log("Respuesta del servidor:", data);

                if (!data.pdf_url) {
                    throw new Error('No se recibió URL del PDF');
                }

                // Intentar abrir el PDF
                if (pdfWindow) {
                    pdfWindow.location.href = data.pdf_url;
                } else {
                    // Método alternativo si falla window.open
                    const link = document.createElement('a');
                    link.href = data.pdf_url;
                    link.target = '_blank';
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    setTimeout(() => document.body.removeChild(link), 100);
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Error al generar el PDF: ' + error.message);
                if (pdfWindow) pdfWindow.close();
            } finally {
                // Cerrar alerta de carga si existe
                if (loadingAlert && loadingAlert.close) loadingAlert.close();
            }
        };

        // Disparar el selector de archivos
        fileInput.click();
    }

    function getCsrfToken() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        return csrfToken ? csrfToken.value : '';
    }
    document.addEventListener('click', function (event) {
        if (event.target && event.target.classList.contains('select-all')) {
            const checkboxes = document.querySelectorAll('#valoraciones-table tbody input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);

            if (allChecked) {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                event.target.textContent = 'Seleccionar Todo';
            } else {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
                event.target.textContent = 'Deseleccionar Todo';
            }
        }
    });

</script>
<style>
    html,
    body {
        margin: 0;
        padding: 0;
        width: 100%;
        overflow-x: hidden;
        background: #f8f9fa;
    }

    .container-fluid {
        padding: 0 !important;
        margin: 0 !important;
        max-width: 100%;
    }

    .bg-blue {
        background-color: #001ba3 !important;
    }

    .btn-clear {
        background-color: #00e1a1;
        color: white;
        border: none;
    }

    .btn-clear:hover {
        background-color: #00997a;
        color: #fff;
    }

    .form-section {
        background-color: white;
        padding: 20px;
    }

    .table-section {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .header-white {
        background-color: white;
        height: 70px;
    }

    .filter-section {
        background-color: #001ba3;
        color: white;
        padding: 10px 0;
        border-radius: 0 0 8px 8px;
    }

    #valoraciones-table th {
        padding-top: 0.68rem;
        padding-bottom: 0.68rem;
        background-color: #001ba3;
        color: white;
        text-align: center;
        vertical-align: middle;
    }

    #valoraciones-table td {
        padding-top: 0.68rem;
        padding-bottom: 0.68rem;
        background-color: white;
        color: black;
        text-align: center;
        vertical-align: middle;
    }

    .table-bordered {
        border: 2px solid #000000;
    }

    .hidden-column {
        display: none;
    }

    .btn-outline-primary {
        color: #001ba3;
        border-color: #001ba3;
    }

    .btn-outline-primary:hover {
        background-color: #001ba3;
        color: white;
    }

    .table-container button {
        min-width: 150px;
    }

    @media (max-width: 991.98px) {

        .table-section,
        .filter-section {
            padding: 10px;
        }

        .table-container button {
            min-width: 100px;
            font-size: 0.95rem;
        }
    }

    .btn-spacing {
        margin-right: 20px;
    }
</style>
{% endblock %}