{% extends 'sidebar.html' %}
{% block content %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PredictBuild Dashboard</title>
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" as="style"
        onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    </noscript>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

</head>

<body>
    <div class="container-fluid">
        <!-- Título (azul completo) -->
        <div class="top-bar d-flex flex-column px-0">

            <div class="row g-0 text-black filters-row align-items-center"
                style="height: 70px; background-color: white;">
                <div class="col-md-1 text-start ps-3"></div>
                <div class="col-md-3">
                    <h4 class="m-0" style="color: #001ba3;">REGISTRO</h4>
                </div>
                <div class="col-md-4 text-center">
                    {%load static%}
                    <img src="{%static 'images/logo.jpeg'%}" alt="Logo PredictBuild" width="100px" height="70px">
                </div>
            </div>
            <!-- Barra de búsqueda (azul completo) -->
            <div class="row g-0">
                <div class="col-12 bg-blue p-2">
                    <div class="row ms-1">
                        <div class="col-md-4">
                            <input type="text" id="buscar-calle" class="form-control"
                                placeholder="BUSQUE POR DIRECCIÓN">
                        </div>
                    </div>
                </div>
            </div>


            <!-- Filtros (azul completo) -->
            <div class="row g-0 filter-section">
                <div class="col-12 bg-blue p-2">
                    <form class="row gx-2 gy-1 align-items-end">
                        <div class="col-6 col-md-2 col-lg-1">
                            <label class="form-label mb-1">Desde:</label>
                            <input type="date" class="form-control form-control-sm" id="desde">
                        </div>
                        <div class="col-6 col-md-2 col-lg-1">
                            <label class="form-label mb-1">Hasta:</label>
                            <input type="date" class="form-control form-control-sm" id="hasta">
                        </div>
                        <div class="col-6 col-md-2 col-lg-1">
                            <label class="form-label mb-1">Ciudad:</label>
                            <select id="ciudad_1" class="form-select form-select-sm" aria-label="Seleccionar ciudad"
                                onchange="cargarDistritos('1')"></select>
                        </div>
                        <div class="col-6 col-md-2 col-lg-1">
                            <label class="form-label mb-1">Distrito:</label>
                            <select id="distrito_1" class="form-select form-select-sm"
                                onchange="cargarBarrios('1')"></select>
                        </div>
                        <div class="col-6 col-md-2 col-lg-1">
                            <label class="form-label mb-1">Barrio:</label>
                            <select id="barrio_1" class="form-select form-select-sm"
                                onchange="cargarCalle('1')"></select>
                        </div>
                        <div class="col-6 col-md-2 col-lg-1">
                            <label class="form-label mb-1">Calle:</label>
                            <select id="calle_1" class="form-select form-select-sm"></select>
                        </div>
                        <div class="col-6 col-md-2 col-lg-1">
                            <label class="form-label mb-1">Tipo:</label>
                            <select id="tipo_1" class="form-select form-select-sm">
                                <option value="">Todos</option>
                                <option value="valoracion">valoracion</option>
                                <option value="registro">registro</option>
                                <option value="informe">informe</option>
                            </select>
                        </div>
                        <div class="col-6 col-md-3 col-lg-2">
                            <label class="form-label mb-1">Precio Desde:</label>
                            <select id="precio-desde" class="form-select form-select-sm">
                                <option value="">Todos</option>
                                <option value="200000">200.000</option>
                                <option value="400000">400.000</option>
                                <option value="600000">600.000</option>
                            </select>
                        </div>
                        <div class="col-6 col-md-3 col-lg-2">
                            <label class="form-label mb-1">Precio Hasta:</label>
                            <select id="precio-hasta" class="form-select form-select-sm">
                                <option value="">Todos</option>
                                <option value="1000000">1.000.000</option>
                                <option value="2000000">2.000.000</option>
                                <option value="3000000">3.000.000</option>
                            </select>
                        </div>

                        <div class="col-12 col-md-2 col-lg-1">
                            <button type="button" id="limpiar-filtros"
                                class="btn btn btn-hover-green me-2 btn-sm w-100 mt-2">
                                LIMPIAR FILTROS
                            </button>

                        </div>
                    </form>
                </div>
            </div>
            <!-- Contenido principal dividido en 2 columnas -->
            <div class="row g-0">
                <!-- Columna izquierda - Registrar Venta -->
                <div class="col-lg-5">
                    <!-- Título de sección (azul completo del ancho de la columna) -->
                    <div class="row g-0">
                        <div class="col-12 bg-blue p-2">
                            <h4 class="text-white text-center fw-bold mb-0">
                                REGISTRAR VENTA</h4>
                        </div>
                    </div>

                    <!-- Formulario -->
                    <div class="form-section p-3">
                        <form id="valuation-form">
                            {% csrf_token %}
                            <div class="row g-3 align-items-start">
                                <div class="row g-3">
                                    <!-- Primera columna -->
                                    <div class="col-12 col-lg-4 col-md-6">
                                        <label for="ciudad" class="form-label">Ciudad:</label>
                                        <select id="ciudad_2" class="form-select"
                                            onchange="cargarDistritos('2')"></select>
                                        <label for="distrito" class="form-label">Distrito:</label>
                                        <select id="distrito_2" class="form-select"
                                            onchange="cargarBarrios('2')"></select>
                                        <label for="barrio" class="form-label">Barrio:</label>
                                        <select id="barrio_2" class="form-select" onchange="cargarCalle('2')"></select>
                                        <label for="calle" class="form-label">Calle:</label>
                                        <select id="calle_2" class="form-select"
                                            aria-label="Seleccionar calle"></select>
                                        <label for="tipo-vivienda" class="form-label mt-3">Tipo de vivienda:</label>
                                        <select id="tipo-vivienda" class="form-select"
                                            aria-label="Seleccionar tipo de vivienda">
                                            <option value="0">Estudio</option>
                                            <option value="1">Piso</option>
                                            <option value="2">Chalet adosado</option>
                                            <option value="3">Dúplex</option>
                                            <option value="4">Ático</option>
                                            <option value="5">Chalet pareado</option>
                                            <option value="6">Casa o chalet</option>
                                        </select>
                                    </div>

                                    <!-- Segunda columna -->
                                    <div class="col-12 col-lg-4 col-md-6">
                                        <label for="num-banos" class="form-label">Número de baños:</label>
                                        <input id="num-banos" class="form-control" type="number" min="1" step="1"
                                            placeholder="" aria-label="Número de baños">
                                        <label for="num-habitaciones" class="form-label">Número de
                                            habitaciones:</label>
                                        <input id="num-habitaciones" class="form-control" type="number" min="1" step="1"
                                            placeholder="" aria-label="Número de habitaciones">
                                        <label for="metros-cuadrados" class="form-label">Metros Cuadrados:</label>
                                        <input id="metros-cuadrados" class="form-control" type="number" min="1" step="1"
                                            placeholder="" aria-label="Metros cuadrados">
                                        <label for="planta" class="form-label">Planta:</label>
                                        <select id="planta" class="form-select" aria-label="Seleccionar planta">
                                            <option value="-3">Sótano</option>
                                            <option value="-2">Semi-Sótano</option>
                                            <option value="-1">Entreplanta</option>
                                            <option value="0">Bajo</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                            <option value="6">6</option>
                                            <option value="7">7</option>
                                            <option value="8">8</option>
                                        </select>

                                        <label for="tiene-ascensor" class="form-label mt-3">Tiene ascensor:</label>
                                        <select id="tiene-ascensor" class="form-select"
                                            aria-label="Seleccionar ascensor">
                                            <option value="0">No</option>
                                            <option value="1">Sí</option>
                                        </select>
                                    </div>
                                    <div class="col-12 col-lg-4 col-md-6">
                                        <label for="estado-inmueble" class="form-label">Estado del
                                            inmueble:</label>
                                        <select id="estado-inmueble" class="form-select">
                                            <option value="0">Obra nueva</option>
                                            <option value="1">Segunda Mano/buen estado</option>
                                            <option value="2">Segunda Mano/para reformar</option>
                                            <option value="3">No declara</option>
                                        </select>
                                        <label for="tiene-terraza" class="form-label">Tiene terraza:</label>
                                        <select id="tiene-terraza" class="form-select">
                                            <option value="0">No</option>
                                            <option value="1">Sí</option>
                                        </select>
                                        <label for="tiene-balcon" class="form-label">Tiene balcón:</label>
                                        <select id="tiene-balcon" class="form-select">
                                            <option value="0">No</option>
                                            <option value="1">Sí</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- Botones -->
                                <div class="row mt-4">
                                    <div class="col-6">
                                        <div class="text-center">
                                            <!-- Botones Registrar y Generar Informe -->
                                            <button type="button" class="btn fw-bold w-100 py-2 btn-hover-blue"
                                                id="registrarinf">
                                                REGISTRAR
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center">
                                            <button type="button" class="btn fw-bold w-100 py-2 btn-hover-blue"
                                                id="generarinf2" onclick="window.location.href='/home/generarinf'">
                                                GENERAR INFORME
                                            </button>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </form>
                    </div>
                </div>

                <div class="col-lg-7 p-0 m-0" style="height: 100%; display: flex; flex-direction: column;">
                    <!-- Tabla -->
                    <div class="table-section p-0 m-0">
                        <table id="valoraciones-table" class="table table-sm table-bordered w-100 m-0">
                            <thead>
                                <tr>
                                    <th>Seleccionar</th>
                                    <th>Fecha</th>
                                    <th>Notas</th>
                                    <th>Tipo</th>
                                    <th>Ciudad</th>
                                    <th>Distrito</th>
                                    <th>Barrio</th>
                                    <th>Calle</th>
                                    <th>Precio</th>
                                    <th>Precio Manual</th>
                                    <th class="hidden-column">Planta</th>
                                    <th class="hidden-column">Tipo Vivienda</th>
                                    <th class="hidden-column">Estado</th>
                                    <th class="hidden-column">m²</th>
                                    <th class="hidden-column">Habitaciones</th>
                                    <th class="hidden-column">Baños</th>
                                    <th class="hidden-column">Terraza</th>
                                    <th class="hidden-column">Balcón</th>
                                    <th class="hidden-column">Ascensor</th>
                                    <th class="hidden-column">Precio Mínimo</th>
                                    <th class="hidden-column">Precio Esperado</th>
                                    <th class="hidden-column">Precio Máximo</th>
                                    <th class="hidden-column">Precio Único</th>
                                    <th class="hidden-column">IDV</th>

                                </tr>
                            </thead>
                            <tbody>
                                {% for valoracion in valoraciones %}
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>{{ valoracion.fecha_guardado }}</td>
                                    <td></td>
                                    <td>{{ valoracion.modo }}</td>
                                    <td>{{ valoracion.ciudad }}</td>
                                    <td>{{ valoracion.distrito }}</td>
                                    <td>{{ valoracion.barrio }}</td>
                                    <td>{{ valoracion.calle }}</td>
                                    <td>
                                        {{ valoracion.precio_esperado }}
                                    </td>
                                    <td>
                                        {{ valoracion.precio_esperado_unico }}
                                    </td>

                                    <!-- columnas ocultas -->
                                    <td class="hidden-column">{{ valoracion.planta }}</td>
                                    <td class="hidden-column">{{ valoracion.tipo_vivienda }}</td>
                                    <td class="hidden-column">{{ valoracion.estado }}</td>
                                    <td class="hidden-column">{{ valoracion.m2 }}</td>
                                    <td class="hidden-column">{{ valoracion.num_habitaciones }}</td>
                                    <td class="hidden-column">{{ valoracion.num_banos }}</td>
                                    <td class="hidden-column">{{ valoracion.terraza }}</td>
                                    <td class="hidden-column">{{ valoracion.balcon }}</td>
                                    <td class="hidden-column">{{ valoracion.ascensor }}</td>
                                    <td class="hidden-column">{{ valoracion.precio_minimo }}</td>
                                    <td class="hidden-column">{{ valoracion.precio_esperado }}</td>
                                    <td class="hidden-column">{{ valoracion.precio_maximo }}</td>
                                    <td class="hidden-column">{{ valoracion.precio_esperado_unico }}</td>
                                    <td class="hidden-column">{{ valoracion.idv}}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="table-container text-center mt-3" style="text-align: center; margin-top: 20px;">
                        <!-- Botones debajo de la tabla -->
                        <button class="open-record btn btn-hover-blue me-2" style="margin-bottom: 10px;">Cargar
                            Datos</button>
                        <button class="export-to-excel btn btn-hover-green me-2" style="margin-bottom: 10px;">
                            Exportar a Excel
                        </button>
                        <button class="open-record btn btn-hover-blue" style="margin-bottom: 10px;">Seleccionar
                            Todo</button>
                    </div>
                </div>
            </div>
        </div>
</body>
<script>
    let valoracionSeleccionada = null;
    $(document).ready(function () {
        if ($.fn.DataTable.isDataTable('#valoraciones-table')) {
            $('#valoraciones-table').DataTable().clear().destroy();
        }

        $('#valoraciones-table').DataTable({
            scrollY: "400px",
            scrollX: true,
            scrollCollapse: true,
            paging: false,
            info: false,
            searching: false,
            lengthChange: false,
            order: [[1, "desc"]],
            columnDefs: [
                { orderable: false, targets: 0 }
            ],
            language: {
                zeroRecords: "No se encontraron resultados"
            },
            fixedHeader: true
        });
    });



    document.getElementById('desde').addEventListener('change', filtrarTodo);
    document.getElementById('hasta').addEventListener('change', filtrarTodo);
    window.addEventListener('DOMContentLoaded', () => {
        const hoy = new Date();
        const yyyy = hoy.getFullYear();
        const mm = String(hoy.getMonth() + 1).padStart(2, '0'); // Mes +1 porque es base 0
        const dd = String(hoy.getDate()).padStart(2, '0');

        const fechaHoy = `${yyyy}-${mm}-${dd}`;
        const fechaEnero = `${yyyy}-01-01`;

        const desdeInput = document.getElementById('desde');
        const hastaInput = document.getElementById('hasta');

        if (desdeInput && !desdeInput.value) desdeInput.value = fechaEnero;
        if (hastaInput && !hastaInput.value) hastaInput.value = fechaHoy;
    });


    const optionsJson = '{{ options_json|escapejs }}';
    const ciudadSe = JSON.parse('{{ context_json|escapejs }}');

    if (optionsJson.trim() === "") {
        console.error("La variable options_json está vacía.");
    } else {
        const selectCiudad = document.getElementById('ciudad');
        cargarCiudades('1')
        cargarCiudades('2')
    }
    function cargarCiudades(sufijo) {
        if (optionsJson.trim() === "") {
            console.error("La variable options_json está vacía.");
            return;
        }

        const options = JSON.parse(optionsJson);

        const selectCiudad = document.getElementById('ciudad_' + sufijo);

        selectCiudad.innerHTML = '';
        if (sufijo == 1) {
            const optionTodos = document.createElement('option');
            optionTodos.value = '';
            optionTodos.textContent = 'Todos';
            optionTodos.selected = true;
            selectCiudad.appendChild(optionTodos);
        }
        options.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option.id;
            optionElement.textContent = option.name;
            selectCiudad.appendChild(optionElement);
        });
        if (sufijo != 1) {
            const ciudad = ciudadSe.ciudad;
            if (ciudad) {
                const optionToSelect = Array.from(selectCiudad.options).find(option => option.value === ciudad);
                if (optionToSelect) {
                    optionToSelect.selected = true;
                    selectCiudad.dispatchEvent(new Event('change'));
                }
            }
        }
        if (sufijo == 1) {
            filtrarTodo();
        }
    }

    function cargarDistritos(sufijo) {
        const ciudadSelect = document.getElementById('ciudad_' + sufijo);
        const distritoSelect = document.getElementById('distrito_' + sufijo);

        const ciudadSeleccionada = ciudadSelect?.value;
        if (!ciudadSeleccionada) {
            if (distritoSelect) distritoSelect.innerHTML = '';
            console.log("a");
            return;
        }

        console.log(`URL de la solicitud: /home/get_distritos/${encodeURIComponent(ciudadSeleccionada)}/`);

        fetch(`/home/get_distritos/${encodeURIComponent(ciudadSeleccionada)}/`)
            .then(response => response.json())
            .then(data => {
                if (!distritoSelect) return;

                distritoSelect.innerHTML = '';

                // SOLO para sufijo 1
                if (sufijo == 1) {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = "Todos";
                    defaultOption.selected = true;  // por defecto en "Todos"
                    distritoSelect.appendChild(defaultOption);
                }

                data.distritos.forEach(distrito => {
                    const option = document.createElement('option');
                    option.value = distrito.id;
                    option.textContent = distrito.name;
                    distritoSelect.appendChild(option);
                });

                // Solo seleccionar distrito si sufijo != 1
                if (sufijo != 1) {
                    const distritoSe = JSON.parse('{{ context_json|escapejs }}');
                    const distrito = distritoSe.distrito;
                    console.log("distrito:", distrito);
                    if (distrito) {
                        const seleccion = Array.from(distritoSelect.options).find(option => option.value === distrito);
                        if (seleccion) {
                            seleccion.selected = true;
                            distritoSelect.dispatchEvent(new Event('change'));
                        }
                    }
                }
            })
            .catch(error => console.error('Error al cargar los distritos:', error));

        if (sufijo == 1) {
            filtrarTodo();
        }
    }
    function cargarBarrios(sufijo) {
        const distritoSelect = document.getElementById('distrito_' + sufijo);
        const barrioSelect = document.getElementById('barrio_' + sufijo);

        const distritoSeleccionado = distritoSelect?.value;

        if (!distritoSeleccionado) {
            console.log("No se seleccionó ningún distrito.");
            if (barrioSelect) barrioSelect.innerHTML = '';
            return;
        }

        console.log(`URL de la solicitud: /home/get_barrios/${encodeURIComponent(distritoSeleccionado)}/`);

        fetch(`/home/get_barrios/${encodeURIComponent(distritoSeleccionado)}/`)
            .then(response => response.json())
            .then(data => {
                console.log('Datos recibidos del servidor:', data);

                if (!barrioSelect) return;
                barrioSelect.innerHTML = '';

                // SOLO para sufijo 1
                if (sufijo == 1) {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = "Todos";
                    defaultOption.selected = true;  // por defecto en "Todos"
                    barrioSelect.appendChild(defaultOption);
                }

                data.barrio.forEach(barrio => {
                    const option = document.createElement('option');
                    option.value = barrio.id;
                    option.textContent = barrio.name;
                    barrioSelect.appendChild(option);
                });

                // Solo seleccionar barrio si sufijo != 1
                if (sufijo != 1) {
                    const barrioSe = JSON.parse('{{ context_json|escapejs }}');
                    const barrio = barrioSe.barrio;
                    if (barrio) {
                        const seleccion = Array.from(barrioSelect.options).find(option => option.value === barrio);
                        if (seleccion) {
                            seleccion.selected = true;
                            barrioSelect.dispatchEvent(new Event('change'));
                        }
                    }
                }
            })
            .catch(error => console.error('Error al cargar los barrios:', error));

        if (sufijo == 1) {
            filtrarTodo();
        }
    }

    function cargarCalle(sufijo) {
        const barrioSelect = document.getElementById('barrio_' + sufijo);
        const calleSelect = document.getElementById('calle_' + sufijo);

        const barrioSeleccionado = barrioSelect?.value;

        if (!barrioSeleccionado) {
            console.log("No se seleccionó ningún barrio.");
            if (calleSelect) calleSelect.innerHTML = '';
            return;
        }

        console.log(`URL de la solicitud: /home/get_calles/${encodeURIComponent(barrioSeleccionado)}/`);

        fetch(`/home/get_calles/${encodeURIComponent(barrioSeleccionado)}/`)
            .then(response => response.json())
            .then(data => {
                console.log('Datos recibidos del servidor:', data);

                if (!calleSelect) return;
                calleSelect.innerHTML = '';

                // SOLO para sufijo 1
                if (sufijo == 1) {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = "Todos";
                    defaultOption.selected = true;  // por defecto en "Todos"
                    calleSelect.appendChild(defaultOption);
                }

                data.calle.forEach(calle => {
                    const option = document.createElement('option');
                    option.value = calle.id;
                    option.textContent = calle.name;
                    calleSelect.appendChild(option);
                });

                // Solo seleccionar calle si sufijo != 1
                if (sufijo != 1) {
                    const calleSe = JSON.parse('{{ context_json|escapejs }}');
                    const calle = calleSe.calle;
                    if (calle) {
                        const seleccion = Array.from(calleSelect.options).find(option => option.value === calle);
                        if (seleccion) {
                            seleccion.selected = true;
                            calleSelect.dispatchEvent(new Event('change'));
                        }
                    }
                }
            })
            .catch(error => console.error('Error al cargar las calles:', error));

        if (sufijo == 1) {
            filtrarTodo();
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        const ciudadSe = JSON.parse('{{ context_json|escapejs }}');
        console.log("JEISON", ciudadSe)
        if (ciudadSe) {
            document.getElementById('num-banos').value = ciudadSe.num_banos || '';
            document.getElementById('num-habitaciones').value = ciudadSe.num_habitaciones || '';
            document.getElementById('metros-cuadrados').value = ciudadSe.m2 || '';

            const plantaSelect = document.getElementById('planta');
            plantaSelect.value = ciudadSe.planta || '';

            const ascensorSelect = document.getElementById('tiene-ascensor');
            ascensor = ciudadSe.ascensor;
            if (ascensor !== undefined && ascensor !== null) {
                const seleccion = Array.from(ascensorSelect.options).find(option => option.value === String(ascensor));
                if (seleccion) {
                    seleccion.selected = true;
                    ascensorSelect.dispatchEvent(new Event('change'));
                }
            }
            const estadoSelect = document.getElementById('estado-inmueble');
            estadoSelect.value = ciudadSe.estado || '';

            const tipoSelect = document.getElementById('tipo-vivienda');
            tipoSelect.value = ciudadSe.tipo_vivienda || '';

            const terrazaSelect = document.getElementById('tiene-terraza');
            terrazaSelect.value = ciudadSe.terraza || '';

            const balconSelect = document.getElementById('tiene-balcon');
            balconSelect.value = ciudadSe.balcon || '';


            const precio_min = document.getElementById('precio-minimo');
            precio_min.textContent = ciudadSe.precio_minimo || '';

            const precio_max = document.getElementById('precio-maximo');
            precio_max.textContent = ciudadSe.precio_maximo || '';

            const precio_esp = document.getElementById('precio-esperado');
            precio_esp.textContent = ciudadSe.precio_esperado || '';

            const precio_esu = document.getElementById('precio-esperado-unico');
            precio_esu.textContent = ciudadSe.precio_esperado_unico || '';

        }
    });


    document.body.addEventListener('click', function (event) {
        if (event.target && event.target.matches('.export-to-excel')) {
            excelAbrir();
        }
        if (event.target && event.target.matches('.open-record')) {
            excelAbrir();
        }
    });
    function excelAbrir() {
        if (event.target && event.target.classList.contains('export-to-excel')) {
            const viviendaMap = {
                0: "Estudio",
                1: "Piso",
                2: "Chalet adosado",
                3: "Dúplex",
                4: "Ático",
                5: "Chalet pareado",
                6: "Casa o chalet"
            };
            const plantaMap = {
                0: "Sótano",
                1: "Semi-Sótano",
                2: "Entreplanta",
                3: "Bajo",
                4: "1",
                5: "2",
                6: "3",
                7: "4",
                8: "5",
                9: "6",
                10: "7",
                11: "8"
            };
            const ascensorMap = {
                'false': "No",
                'true': "Sí"
            };
            const estadoInmuebleMap = {
                0: "Obra nueva",
                1: "Segunda Mano/buen estado",
                2: "Segunda Mano/para reformar",
                3: "No declara"
            };
            const terrazaBalconMap = {
                'false': "No",
                'true': "Sí"
            };
            const selectedRows = [];

            document.querySelectorAll('tbody tr').forEach(row => {
                const checkbox = row.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    const rowData = {
                        fecha_guardado: row.querySelector('td:nth-child(2)').textContent.trim(),
                        modo: row.querySelector('td:nth-child(4)').textContent.trim(),
                        ciudad: row.querySelector('td:nth-child(5)').textContent.trim(),
                        distrito: row.querySelector('td:nth-child(6)').textContent.trim(),
                        barrio: row.querySelector('td:nth-child(7)').textContent.trim(),
                        calle: row.querySelector('td:nth-child(8)').textContent.trim(),
                        planta: row.querySelector('td:nth-child(11)').textContent.trim(),
                        tipo_vivienda: row.querySelector('td:nth-child(12)').textContent.trim(),
                        estado_inmueble: row.querySelector('td:nth-child(13)').textContent.trim(),
                        metros_cuadrados: row.querySelector('td:nth-child(14)').textContent.trim(),
                        num_habitaciones: row.querySelector('td:nth-child(15)').textContent.trim(),
                        num_banos: row.querySelector('td:nth-child(16)').textContent.trim(),
                        terraza: row.querySelector('td:nth-child(17)').textContent.trim() === 'True' ? 'SI' : 'NO',
                        balcon: row.querySelector('td:nth-child(18)').textContent.trim() === 'True' ? 'SI' : 'NO',
                        ascensor: row.querySelector('td:nth-child(19)').textContent.trim() === 'True' ? 'SI' : 'NO',
                        precio_minimo: row.querySelector('td:nth-child(20)').textContent.trim() === 'None' ? '0' : row.querySelector('td:nth-child(20)').textContent.trim(),
                        precio_esperado: row.querySelector('td:nth-child(21)').textContent.trim() === 'None' ? '0' : row.querySelector('td:nth-child(21)').textContent.trim(),
                        precio_maximo: row.querySelector('td:nth-child(22)').textContent.trim() === 'None' ? '0' : row.querySelector('td:nth-child(22)').textContent.trim(),
                        precio_esperado_unico: row.querySelector('td:nth-child(23)').textContent.trim() === 'None' ? '0' : row.querySelector('td:nth-child(23)').textContent.trim(),
                    };
                    selectedRows.push(rowData);
                    console.log("DATOS DEL EXCEL", rowData)
                }
            });

            if (selectedRows.length === 0) {
                alert('Por favor, seleccione al menos una fila para exportar.');
                return;
            }

            fetch('/home/exportar_excel/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                },
                body: JSON.stringify({ seleccionados: selectedRows }),
            })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'valoraciones_seleccionadas.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                })
                .catch(error => console.error('Error al exportar el archivo:', error));
        }

        if (event.target && event.target.classList.contains('open-record')) {
            const selectedRows = [];
            document.querySelectorAll('tbody tr').forEach(row => {
                const checkbox = row.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    const rowData = {
                        fecha_guardado: row.querySelector('td:nth-child(2)').textContent.trim(),
                        modo: row.querySelector('td:nth-child(4)').textContent.trim(),
                        ciudad: row.querySelector('td:nth-child(5)').textContent.trim(),
                        distrito: row.querySelector('td:nth-child(6)').textContent.trim(),
                        barrio: row.querySelector('td:nth-child(7)').textContent.trim(),
                        calle: row.querySelector('td:nth-child(8)').textContent.trim(),
                        planta: row.querySelector('td:nth-child(11)').textContent.trim(),
                        tipo_vivienda: row.querySelector('td:nth-child(12)').textContent.trim(),
                        estado_inmueble: row.querySelector('td:nth-child(13)').textContent.trim(),
                        metros_cuadrados: row.querySelector('td:nth-child(14)').textContent.trim(),
                        num_habitaciones: row.querySelector('td:nth-child(15)').textContent.trim(),
                        num_banos: row.querySelector('td:nth-child(16)').textContent.trim(),
                        terraza: row.querySelector('td:nth-child(17)').textContent.trim() === 'True' ? 'SI' : 'NO',
                        balcon: row.querySelector('td:nth-child(18)').textContent.trim() === 'True' ? 'SI' : 'NO',
                        ascensor: row.querySelector('td:nth-child(19)').textContent.trim() === 'True' ? 'SI' : 'NO',
                        precio_minimo: row.querySelector('td:nth-child(20)').textContent.trim() === 'None' ? '0' : row.querySelector('td:nth-child(20)').textContent.trim(),
                        precio_esperado: row.querySelector('td:nth-child(21)').textContent.trim() === 'None' ? '0' : row.querySelector('td:nth-child(21)').textContent.trim(),
                        precio_maximo: row.querySelector('td:nth-child(22)').textContent.trim() === 'None' ? '0' : row.querySelector('td:nth-child(22)').textContent.trim(),
                        precio_esperado_unico: row.querySelector('td:nth-child(23)').textContent.trim() === 'None' ? '0' : row.querySelector('td:nth-child(23)').textContent.trim(),
                        idv: row.querySelector('td:nth-child(24)').textContent.trim(),

                    };
                    selectedRows.push(rowData);
                    valoracionSeleccionada = rowData;
                    console.log("DATOS SELECCIONADOS ", selectedRows)
                }
            });

            if (selectedRows.length === 0) {
                return;
            }

            const selectedRecord = selectedRows[0];
            if (selectedRows.length > 0) {
                const selectedRecord = selectedRows[0];

                document.getElementById('ciudad_2').value = selectedRecord.ciudad;
                cargarDistritos('2');

                setTimeout(() => {
                    document.getElementById('distrito_2').value = selectedRecord.distrito;
                    cargarBarrios('2');

                    setTimeout(() => {
                        document.getElementById('barrio_2').value = selectedRecord.barrio;
                        cargarCalle('2');

                        setTimeout(() => {
                            document.getElementById('calle_2').value = selectedRecord.calle;
                        }, 300);
                    }, 300);
                }, 300);


                document.getElementById('tipo-vivienda').value = selectedRecord.tipo_vivienda;
                document.getElementById('num-banos').value = selectedRecord.num_banos;
                document.getElementById('num-habitaciones').value = selectedRecord.num_habitaciones;
                document.getElementById('metros-cuadrados').value = selectedRecord.metros_cuadrados;
                document.getElementById('planta').value = selectedRecord.planta;
                document.getElementById('tiene-ascensor').value = selectedRecord.ascensor === 'SI' ? '1' : '0';
                document.getElementById('estado-inmueble').value = selectedRecord.estado_inmueble;


                document.getElementById('tiene-terraza').value = selectedRecord.terraza === 'SI' ? '1' : '0';
                document.getElementById('tiene-balcon').value = selectedRecord.balcon === 'SI' ? '1' : '0';
            }
            const mainContent = document.getElementById('main-content');

            document.body.addEventListener('click', function (event) {
                if (event.target && event.target.matches('.filter-button')) {
                    filtrar();
                }
            });
        }
    };

    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    document.getElementById('tipo_1').addEventListener('change', filtrarTodo);

    function filtrarTodo() {
        console.log("filtrarTodo ejecutado");

        const desdeInput = document.getElementById('desde');
        const hastaInput = document.getElementById('hasta');
        const tipoInput = document.getElementById('tipo_1');
        const precioDesdeInput = document.getElementById('precio-desde');
        const precioHastaInput = document.getElementById('precio-hasta');

        let desdeStr = desdeInput?.value || '';
        let hastaStr = hastaInput?.value || '';
        let tipo = tipoInput?.value.toLowerCase() || '';
        let precioDesde = parseFloat(precioDesdeInput?.value) || 0;
        let precioHasta = parseFloat(precioHastaInput?.value) || Infinity;

        if (tipo === 'todos' || tipo === 'seleccionar') tipo = '';

        let ciudad = document.getElementById('ciudad_1')?.value.toLowerCase() || '';
        let distrito = document.getElementById('distrito_1')?.value.toLowerCase() || '';
        let barrio = document.getElementById('barrio_1')?.value.toLowerCase() || '';
        let calle = document.getElementById('calle_1')?.value.toLowerCase() || '';

        if (distrito === 'todos' || distrito === 'seleccionar') distrito = '';
        if (barrio === 'todos' || barrio === 'seleccionar') barrio = '';
        if (calle === 'todos' || calle === 'seleccionar') calle = '';

        const tabla = document.getElementById('valoraciones-table');
        const filas = tabla.tBodies[0].rows;

        for (let fila of filas) {
            let mostrar = true;

            // Fecha
            const textoFecha = fila.cells[1].textContent.trim(); // dd/mm/yyyy
            const partes = textoFecha.split('/');
            let fechaFilaStr = '';

            if (partes.length === 3) {
                const dia = partes[0].padStart(2, '0');
                const mes = partes[1].padStart(2, '0');
                const anio = partes[2];
                fechaFilaStr = `${anio}-${mes}-${dia}`; // yyyy-mm-dd
            }

            if (desdeStr && fechaFilaStr < desdeStr) mostrar = false;
            if (hastaStr && fechaFilaStr > hastaStr) mostrar = false;

            // Tipo
            if (tipo && !fila.cells[3].textContent.toLowerCase().includes(tipo)) mostrar = false;

            // Ciudad, distrito, barrio, calle
            if (ciudad && !fila.cells[4].textContent.toLowerCase().includes(ciudad)) mostrar = false;
            if (distrito && !fila.cells[5].textContent.toLowerCase().includes(distrito)) mostrar = false;
            if (barrio && !fila.cells[6].textContent.toLowerCase().includes(barrio)) mostrar = false;
            if (calle && !fila.cells[7].textContent.toLowerCase().includes(calle)) mostrar = false;

            // Precio
            const textoPrecio = fila.cells[8].textContent.trim().replace(/\./g, '').replace(',', '.');
            const precio = parseFloat(textoPrecio) || 0;
            if (precio < precioDesde || precio > precioHasta) mostrar = false;

            fila.style.display = mostrar ? '' : 'none';
        }
    }


    document.querySelectorAll('.filter-section input, .filter-section select').forEach(elem => {
        elem.addEventListener('change', filtrarTodo);
    });


    document.getElementById('ciudad_1').addEventListener('change', () => {
        document.getElementById('distrito_1').innerHTML = '<option value="">-- Seleccionar distrito --</option>';
        document.getElementById('barrio_1').innerHTML = '<option value="">-- Seleccionar barrio --</option>';
        document.getElementById('calle_1').innerHTML = '<option value="">-- Seleccionar calle --</option>';
        filtrarTodo();
    });
    document.getElementById('distrito_1').addEventListener('change', () => {
        document.getElementById('barrio_1').innerHTML = '<option value="">-- Seleccionar barrio --</option>';
        document.getElementById('calle_1').innerHTML = '<option value="">-- Seleccionar calle --</option>';
        filtrarTodo();
    });
    document.getElementById('barrio_1').addEventListener('change', () => {
        document.getElementById('calle_1').innerHTML = '<option value="">-- Seleccionar calle --</option>';
        filtrarTodo();
    });

    document.querySelectorAll('.filter-section input, .filter-section select').forEach(elem => {
        elem.addEventListener('change', filtrarTodo);
    });
    document.getElementById('desde').addEventListener('change', filtrarTodo);
    document.getElementById('hasta').addEventListener('change', filtrarTodo);

    document.getElementById('buscar-calle').addEventListener('input', function () {
        const filtro = this.value.toLowerCase();
        const filas = document.querySelectorAll('#valoraciones-table tbody tr');

        filas.forEach(fila => {
            const calle = fila.children[7].textContent.toLowerCase();

            if (calle.includes(filtro)) {
                fila.style.display = '';
            } else {
                fila.style.display = 'none';
            }
        });
    });
    function filtrarPorPrecio() {
        const precioDesde = parseFloat(document.getElementById('precio-desde').value) || 0;
        const precioHasta = parseFloat(document.getElementById('precio-hasta').value) || Infinity;

        const filas = document.querySelectorAll('#valoraciones-table tbody tr');

        filas.forEach(fila => {
            const textoPrecio = fila.children[8].textContent.trim().replace(/\./g, '').replace(',', '.');
            const precio = parseFloat(textoPrecio) || 0;

            if (precio >= precioDesde && precio <= precioHasta) {
                fila.style.display = '';
            } else {
                fila.style.display = 'none';
            }
        });
    }

    // Activar filtro cuando cambie el select
    document.getElementById('precio-desde').addEventListener('change', filtrarPorPrecio);
    document.getElementById('precio-hasta').addEventListener('change', filtrarPorPrecio);


    document.getElementById('limpiar-filtros').addEventListener('click', function () {
        document.getElementById('buscar-calle').value = '';
        document.getElementById('desde').value = '';
        document.getElementById('hasta').value = '';
        document.getElementById('ciudad_1').selectedIndex = 0;
        document.getElementById('distrito_1').selectedIndex = 0;
        document.getElementById('barrio_1').selectedIndex = 0;
        document.getElementById('calle_1').selectedIndex = 0;
        document.querySelectorAll('.filter-section select').forEach(select => {
            select.selectedIndex = 0;
        });
        const filas = document.querySelectorAll('#valoraciones-table tbody tr');
        filas.forEach(fila => fila.style.display = '');
    });

    document.getElementById('registrarinf').addEventListener('click', async function () {
        const idv = valoracionSeleccionada ? parseInt(valoracionSeleccionada.idv, 10) : null;
        const iduser = "{{user_id}}";
        const modo = "registro";
        const ciudad = document.getElementById('ciudad_2').value;
        const distrito = document.getElementById('distrito_2').value;
        const barrio = document.getElementById('barrio_2').value;
        const calle = document.getElementById('calle_2').value;
        const tipo_vivienda = parseInt(document.getElementById('tipo-vivienda').value, 10);
        const m2 = parseInt(document.getElementById('metros-cuadrados').value, 10);
        const num_habitaciones = parseInt(document.getElementById('num-habitaciones').value, 10);
        const num_banos = parseInt(document.getElementById('num-banos').value, 10);
        const planta = document.getElementById('planta').value;
        const terraza = parseInt(document.getElementById('tiene-terraza').value)
        const balcon = parseInt(document.getElementById('tiene-balcon').value)
        const ascensor = parseInt(document.getElementById('tiene-ascensor').value)
        const estado = document.getElementById('estado-inmueble').value;

        const data = {
            idv: parseInt(idv),
            iduser,
            modo,
            ciudad,
            distrito,
            barrio,
            calle,
            tipo_vivienda,
            m2,
            num_habitaciones,
            num_banos,
            planta,
            terraza,
            balcon,
            ascensor,
            estado,
            precio_minimo: 0,
            precio_esperado: 0,
            precio_maximo: 0,
            precio_esperado_unico: 0,

        };
        console.log("DATOS REGISTRADOS" + JSON.stringify(data))

        const guardarResponse = await fetch('/home/modificar_valoracion/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data),
        });

        if (!guardarResponse.ok) {
            throw new Error(`Error al guardar la valoración. Status: ${guardarResponse.status}`);
        }

        console.log('Valoración guardada correctamente.');
    });

</script>
<style>
    .dataTables_scrollHead table thead th {
        background-color: #001ba3 !important;
        color: white !important;
        padding-top: 4px !important;
        padding-bottom: 4px !important;
        font-size: 13px !important;
        border-color: #001ba3 !important;
    }

    .dataTables_scrollHead table {
        border-bottom: 2px solid #001ba3 !important;
    }

    body,
    html {
        margin: 0;
        padding: 0;
        width: 100%;
        overflow-x: hidden;
    }

    .container-fluid {
        padding: 0 !important;
        margin: 0 !important;
        max-width: 100%;
    }

    .col-lg-5 {
        border-top: 2px solid black;
        border-right: 2px solid black;
    }


    .bg-blue {
        background-color: #001ba3 !important;
    }

    .bg-light-blue {
        background-color: #ADD8E6 !important;
    }

    .form-section {
        background-color: white;
        padding: 20px;
    }

    .table-scroll {
        max-height: 400px;
        overflow-y: auto;
        overflow-x: auto;
        border: 1px solid #ddd;
    }

    .table-section {
        background-color: white;
        padding: 20px;
    }

    .header-white {
        background-color: white;
        height: 70px;
    }

    .filter-section {
        background-color: #001ba3;
        color: white;
        padding: 10px 0;
    }

    #valoraciones-table thead th {
        background-color: #001ba3;
        color: white;
        padding-top: 4px;
        padding-bottom: 4px;
        font-size: 13px;
        position: sticky;
        top: 0;
        z-index: 2;
        text-align: center;
        vertical-align: middle;
    }


    #valoraciones-table td,
    #valoraciones-table th {
        padding-top: 0.68rem;
        padding-bottom: 0.68rem;
    }

    .table-bordered {
        border: 2px solid #000000;
    }


    .hidden-column {
        display: none;
    }

    .btn-hover-blue {
        background-color: #001ba3;
        color: #fff;
        transition: background 0.2s, color 0.2s;
    }

    .btn-hover-blue:hover,
    .btn-hover-blue:focus {
        background-color: #0033cc !important;
        color: #fff !important;
    }

    .btn-hover-green {
        background-color: #01cfa1;
        color: #fff;
        transition: background 0.2s, color 0.2s;
    }

    .btn-hover-green:hover,
    .btn-hover-green:focus {
        background-color: #29ce81 !important;
        color: #fff !important;
    }
</style>

</html>
{% endblock %}